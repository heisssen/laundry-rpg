<form class="laundry-gm-tracker-form" autocomplete="off">
    <header class="gm-tracker-header">
        <h2>{{localize "LAUNDRY.ThreatTrackerTitle"}}</h2>
        <span class="stamp">{{localize "LAUNDRY.Classified"}}</span>
    </header>

    <section class="gm-tracker-block">
        <label for="threat-level">{{localize "LAUNDRY.Threat"}}</label>
        <div class="threat-controls">
            <input id="threat-level" type="range" class="threat-range" min="0" max="10" value="{{threatLevel}}" />
            <input type="number" name="threatLevel" min="0" max="10" value="{{threatLevel}}" />
        </div>
        <button type="submit" class="set-threat">{{localize "LAUNDRY.SetThreat"}}</button>
    </section>

    <section class="gm-tracker-block">
        <h3>{{localize "LAUNDRY.GMQuickActions"}}</h3>
        <div class="gm-quick-actions-grid">
            <button type="button" class="award-luck">{{localize "LAUNDRY.AwardLuckAll"}}</button>
            <button type="button" class="sync-team-luck">{{localize "LAUNDRY.TeamLuckSyncMax"}}</button>
            <button type="button" class="reset-team-luck" data-mode="max">{{localize "LAUNDRY.TeamLuckResetToMax"}}</button>
            <button type="button" class="reset-team-luck" data-mode="zero">{{localize "LAUNDRY.TeamLuckResetToZero"}}</button>
            <button type="button" class="open-mission-generator">Mission Generator</button>
            <button type="button" class="apply-threat-buffs">Apply Threat Buffs</button>
            <button type="button" class="max-adrenaline">{{localize "LAUNDRY.MaxAdrenalineAll"}}</button>
            <button type="button" class="request-bau" {{#unless hasTarget}}disabled{{/unless}}>
                {{localize "LAUNDRY.RequestBAU"}}
            </button>
            <button type="button" class="open-rules">{{localize "LAUNDRY.OpenRulesDossier"}}</button>
            <button type="button" class="open-spells">{{localize "LAUNDRY.OpenSpellsCompendium"}}</button>
        </div>
        <p class="notes">{{localize "LAUNDRY.TeamLuck"}}: <strong>{{teamLuck}}/{{teamLuckMax}}</strong> | Auto-sync: <strong>{{#if teamLuckAutoSync}}ON{{else}}OFF{{/if}}</strong></p>
        <p class="notes">{{localize "LAUNDRY.Target"}}: <strong>{{targetName}}</strong></p>
    </section>

    <section class="gm-tracker-block">
        <h3>{{localize "LAUNDRY.PCResourceBoard"}}</h3>
        {{#if hasPcs}}
        <div class="gm-pc-board">
            {{#each pcs as |pc|}}
            <div class="gm-pc-row" data-actor-id="{{pc.id}}">
                <div class="gm-pc-name">{{pc.name}}</div>
                <div class="gm-pc-resources">
                    <span class="gm-pc-stat">TGH {{pc.toughnessValue}}/{{pc.toughnessMax}}</span>
                    <span class="gm-pc-stat">ADR {{pc.adrenalineValue}}/{{pc.adrenalineMax}}</span>
                    <button type="button" class="pc-adjust" data-actor-id="{{pc.id}}" data-resource="adrenaline" data-delta="-1">-ADR</button>
                    <button type="button" class="pc-adjust" data-actor-id="{{pc.id}}" data-resource="adrenaline" data-delta="1">+ADR</button>
                    <span class="gm-pc-stat">INJ {{pc.injuriesValue}}/{{pc.injuriesMax}}</span>
                    <button type="button" class="pc-adjust" data-actor-id="{{pc.id}}" data-resource="injuries" data-delta="-1">-INJ</button>
                    <button type="button" class="pc-adjust" data-actor-id="{{pc.id}}" data-resource="injuries" data-delta="1">+INJ</button>
                </div>
                <div class="gm-pc-actions">
                    <button type="button" class="pc-bau" data-actor-id="{{pc.id}}">BAU</button>
                    <button type="button" class="pc-kpi-ping" data-actor-id="{{pc.id}}">{{localize "LAUNDRY.KPIPing"}} ({{pc.kpiOpen}})</button>
                    <button type="button" class="pc-open-sheet" data-actor-id="{{pc.id}}">{{localize "LAUNDRY.OpenDossier"}}</button>
                </div>
                <div class="gm-kpi-board">
                    {{#if pc.hasOpenKpis}}
                    <ol class="gm-kpi-list">
                        {{#each pc.kpiEntries as |kpi|}}
                        <li class="gm-kpi-row">
                            <div class="gm-kpi-main">
                                <strong>{{#if kpi.text}}{{kpi.text}}{{else}}(Untitled KPI){{/if}}</strong>
                                <span>{{kpi.horizon}} • {{kpi.priority}} • +{{kpi.rewardPreview.xp}} XP</span>
                            </div>
                            <div class="gm-kpi-actions">
                                <button type="button" class="pc-kpi-close" data-actor-id="{{../id}}" data-kpi-index="{{kpi.index}}" data-kpi-result="completed">Complete</button>
                                <button type="button" class="pc-kpi-close" data-actor-id="{{../id}}" data-kpi-index="{{kpi.index}}" data-kpi-result="failed">Fail</button>
                            </div>
                        </li>
                        {{/each}}
                    </ol>
                    {{else}}
                    <p class="notes">No open KPIs.</p>
                    {{/if}}
                </div>
            </div>
            {{/each}}
        </div>
        {{else}}
        <p class="notes">{{localize "LAUNDRY.NoPlayerCharacters"}}</p>
        {{/if}}
    </section>

    <section class="gm-tracker-block">
        <h3>NPC Rapid Spawn</h3>
        <div class="gm-spawn-grid">
            <select name="spawnPreset">
                {{#each npcPresetGroups as |group|}}
                <optgroup label="{{group.name}}">
                    {{#each group.entries as |preset|}}
                    <option value="{{preset.id}}">{{preset.name}}</option>
                    {{/each}}
                </optgroup>
                {{/each}}
            </select>
            <input type="text" name="spawnName" placeholder="Name (optional)" />
            <input type="number" name="spawnCount" min="1" max="20" value="1" />
            <button type="button" class="spawn-npc">Spawn</button>
        </div>
        <p class="notes">Spawns near your targeted token (or first controlled token if no target).</p>
    </section>

    <section class="gm-tracker-block">
        <h3>Combat Dashboard</h3>
        {{#if hasCombatStarted}}
        <div class="gm-combat-toolbar">
            <input type="text" class="combat-search" value="{{viewState.combatSearch}}" placeholder="Search combatant" />
            <select class="combat-filter">
                {{#each combatFilters as |filter|}}
                <option value="{{filter.id}}" {{#if (laundryEq filter.id @root.viewState.combatFilter)}}selected{{/if}}>{{filter.label}}</option>
                {{/each}}
            </select>
            <select class="combat-sort">
                {{#each combatSorts as |sort|}}
                <option value="{{sort.id}}" {{#if (laundryEq sort.id @root.viewState.combatSort)}}selected{{/if}}>{{sort.label}}</option>
                {{/each}}
            </select>
            <label class="gm-inline-check">
                <input type="checkbox" class="combat-auto-refresh" {{checked viewState.autoRefresh}} />
                <span>Auto-refresh</span>
            </label>
        </div>
        <div class="gm-combat-summary">
            <span class="gm-pc-stat">Visible {{combatSummary.visible}}/{{combatSummary.total}}</span>
            <span class="gm-pc-stat">Total {{combatSummary.total}}</span>
            <span class="gm-pc-stat">Critical {{combatSummary.critical}}</span>
            <span class="gm-pc-stat">No Action {{combatSummary.noActions}}</span>
            <span class="gm-pc-stat">No Move {{combatSummary.noMove}}</span>
            <button type="button" class="combat-next-turn">Next Turn</button>
        </div>
        <div class="gm-combat-selection">
            <button type="button" class="combat-select-all" {{#unless combatants.length}}disabled{{/unless}}>Select Visible</button>
            <button type="button" class="combat-clear-selection" {{#unless combatHasSelections}}disabled{{/unless}}>Clear Selection</button>
            <span class="gm-pc-stat">Selected {{combatSummary.selected}}</span>
        </div>
        <div class="gm-combat-bulk-actions">
            <button type="button" class="combat-bulk-action" data-resource="toughness" data-delta="-1" {{#unless combatHasSelections}}disabled{{/unless}}>-TGH Selected</button>
            <button type="button" class="combat-bulk-action" data-resource="toughness" data-delta="1" {{#unless combatHasSelections}}disabled{{/unless}}>+TGH Selected</button>
            <button type="button" class="combat-bulk-action" data-resource="adrenaline" data-delta="-1" {{#unless combatHasSelections}}disabled{{/unless}}>-ADR Selected</button>
            <button type="button" class="combat-bulk-action" data-resource="adrenaline" data-delta="1" {{#unless combatHasSelections}}disabled{{/unless}}>+ADR Selected</button>
            <button type="button" class="combat-bulk-action" data-resource="action" data-delta="0" {{#unless combatHasSelections}}disabled{{/unless}}>Use Action</button>
            <button type="button" class="combat-bulk-action" data-resource="move" data-delta="0" {{#unless combatHasSelections}}disabled{{/unless}}>Use Move</button>
            <button type="button" class="combat-bulk-action" data-resource="adrenaline-action" data-delta="0" {{#unless combatHasSelections}}disabled{{/unless}}>+Action (ADR)</button>
        </div>
        <div class="gm-combat-bulk-conditions">
            {{#each conditionOptions as |condition|}}
            <button type="button" class="combat-bulk-condition" data-condition-id="{{condition.id}}" {{#unless @root.combatHasSelections}}disabled{{/unless}}>{{condition.label}}</button>
            {{/each}}
        </div>
        {{#if combatants.length}}
        <div class="gm-combat-board">
            {{#each combatants as |entry|}}
            <div class="gm-combat-row {{#if entry.isActive}}gm-combat-active{{/if}} {{#if entry.isCritical}}gm-combat-critical{{/if}}" data-actor-id="{{entry.actorId}}">
                <div class="gm-combat-main">
                    <label class="gm-combat-selector">
                        <input type="checkbox" class="combat-select" data-actor-id="{{entry.actorId}}" {{checked entry.selected}} {{#unless entry.actorId}}disabled{{/unless}} />
                        <span>Sel</span>
                    </label>
                    <strong>{{entry.name}}</strong>
                    <span>{{entry.dispositionLabel}}</span>
                    <span>Init {{entry.initiative}}</span>
                    <span>TGH {{entry.toughnessValue}}/{{entry.toughnessMax}}</span>
                    <span>ADR {{entry.adrenalineValue}}/{{entry.adrenalineMax}}</span>
                    <span>ACT {{entry.actionsRemaining}} | MOV {{entry.moveRemaining}}</span>
                    <span>STS {{entry.statuses}}</span>
                    <span class="gm-combat-hints">{{entry.hints}}</span>
                </div>
                <div class="gm-combat-conditions">
                    {{#each entry.conditionButtons as |condition|}}
                    <button type="button" class="combat-condition-toggle {{#if condition.active}}active{{/if}}" data-actor-id="{{../actorId}}" data-condition-id="{{condition.id}}" {{#unless ../actorId}}disabled{{/unless}}>{{condition.label}}</button>
                    {{/each}}
                </div>
                <div class="gm-combat-actions">
                    <button type="button" class="combat-adjust" data-actor-id="{{entry.actorId}}" data-resource="toughness" data-delta="-1" {{#unless entry.actorId}}disabled{{/unless}}>-TGH</button>
                    <button type="button" class="combat-adjust" data-actor-id="{{entry.actorId}}" data-resource="toughness" data-delta="1" {{#unless entry.actorId}}disabled{{/unless}}>+TGH</button>
                    <button type="button" class="combat-adjust" data-actor-id="{{entry.actorId}}" data-resource="adrenaline" data-delta="-1" {{#unless entry.actorId}}disabled{{/unless}}>-ADR</button>
                    <button type="button" class="combat-adjust" data-actor-id="{{entry.actorId}}" data-resource="adrenaline" data-delta="1" {{#unless entry.actorId}}disabled{{/unless}}>+ADR</button>
                    <button type="button" class="combat-adjust" data-actor-id="{{entry.actorId}}" data-resource="action" data-delta="0" {{#unless entry.actorId}}disabled{{/unless}}>Use Action</button>
                    <button type="button" class="combat-adjust" data-actor-id="{{entry.actorId}}" data-resource="move" data-delta="0" {{#unless entry.actorId}}disabled{{/unless}}>Use Move</button>
                    <button type="button" class="combat-adjust" data-actor-id="{{entry.actorId}}" data-resource="adrenaline-action" data-delta="0" {{#unless entry.actorId}}disabled{{/unless}}>+Action (ADR)</button>
                    <button type="button" class="combat-open-sheet" data-actor-id="{{entry.actorId}}" {{#unless entry.actorId}}disabled{{/unless}}>Sheet</button>
                </div>
            </div>
            {{/each}}
        </div>
        {{else}}
        <p class="notes">No combatants match current filter/search.</p>
        {{/if}}
        {{else}}
        <p class="notes">No active combat dashboard data.</p>
        {{/if}}
    </section>
</form>
