<form class="{{cssClass}} laundry-rpg sheet-agent" autocomplete="off">
    <header class="sheet-header dossier-header">
        <div class="header-left">
            <img class="profile-img" src="{{actor.img}}" data-edit="img"
                 title="{{actor.name}}" height="120" width="120" />
            <div class="header-fields">
                <h1 class="charname">
                    <input name="name" type="text" value="{{actor.name}}"
                           placeholder="{{localize 'LAUNDRY.ActorName'}}" />
                </h1>

                <div class="clearance-row">
                    <span class="stamp clearance-{{system.details.clearance}}">
                        {{system.details.clearance}}
                    </span>
                    <input type="text" name="system.details.department"
                           value="{{system.details.department}}"
                           placeholder="{{localize 'LAUNDRY.Department'}}" class="dept-input" />
                    <input type="text" name="system.details.assignment"
                           value="{{system.details.assignment}}"
                           placeholder="{{localize 'LAUNDRY.Assignment'}}" class="assign-input" />
                    {{#if isCharacter}}
                    {{#unless hasAssignment}}
                    <button type="button" class="init-agent">Initialize Agent</button>
                    {{/unless}}
                    {{#if combat.canEndTurn}}
                    <button type="button" class="end-turn">{{localize "LAUNDRY.EndTurn"}}</button>
                    {{/if}}
                    {{/if}}
                </div>

                <div class="clearance-select-row">
                    <label>{{localize "LAUNDRY.Clearance"}}:</label>
                    <select name="system.details.clearance">
                        {{#each config.clearances as |lvl|}}
                        <option value="{{lvl}}" {{#if (laundryEq lvl ../system.details.clearance)}}selected{{/if}}>{{lvl}}</option>
                        {{/each}}
                    </select>
                </div>
            </div>
        </div>

        <div class="header-attributes">
            <div class="attr-block rollable" data-roll-type="attribute" data-attribute="body"
                 title="Click to roll body">
                <span class="attr-label">{{localize "LAUNDRY.Body"}}</span>
                <input type="number" name="system.attributes.body.value"
                       value="{{system.attributes.body.value}}" data-dtype="Number" min="1" max="10"
                       onclick="event.stopPropagation()" />
            </div>
            <div class="attr-block rollable" data-roll-type="attribute" data-attribute="mind"
                 title="Click to roll mind">
                <span class="attr-label">{{localize "LAUNDRY.Mind"}}</span>
                <input type="number" name="system.attributes.mind.value"
                       value="{{system.attributes.mind.value}}" data-dtype="Number" min="1" max="10"
                       onclick="event.stopPropagation()" />
            </div>
            <div class="attr-block rollable" data-roll-type="attribute" data-attribute="spirit"
                 title="Click to roll spirit">
                <span class="attr-label">{{localize "LAUNDRY.Spirit"}}</span>
                <input type="number" name="system.attributes.spirit.value"
                       value="{{system.attributes.spirit.value}}" data-dtype="Number" min="1" max="10"
                       onclick="event.stopPropagation()" />
            </div>
        </div>
    </header>

    <nav class="sheet-tabs tabs" data-group="primary">
        <a class="item" data-tab="dossier">Dossier</a>
        <a class="item" data-tab="combat">Combat</a>
        {{#if isNpc}}
        <a class="item" data-tab="npc-ops">NPC Ops</a>
        {{/if}}
        <a class="item" data-tab="skills">Skills &amp; Talents</a>
        <a class="item" data-tab="requisition">Requisition</a>
        <a class="item" data-tab="kpis">{{localize "LAUNDRY.KPIs"}}</a>
        <a class="item" data-tab="magic">Magic</a>
    </nav>

    <section class="sheet-body">

        <div class="tab dossier" data-group="primary" data-tab="dossier">
            <div class="panel-grid">
                <section class="panel npc-actions-panel">
                    <h3 class="section-header stamp-red">Derived Stats</h3>
                    <div class="derived-grid">
                        <div class="derived-block">
                            <span class="derived-label">{{localize "LAUNDRY.Toughness"}}</span>
                            <span class="derived-value">{{system.derived.toughness.value}}</span>
                        </div>
                        <div class="derived-block editable-derived">
                            <span class="derived-label">{{localize "LAUNDRY.Injuries"}}</span>
                            <div class="derived-tracker">
                                <input type="number" name="system.derived.injuries.value"
                                       value="{{system.derived.injuries.value}}"
                                       min="0" max="{{system.derived.injuries.max}}" data-dtype="Number" />
                                <span class="sep">/</span>
                                <span class="derived-max">{{system.derived.injuries.max}}</span>
                            </div>
                        </div>
                        <div class="derived-block editable-derived">
                            <span class="derived-label">{{localize "LAUNDRY.Adrenaline"}}</span>
                            <div class="derived-tracker">
                                <input type="number" name="system.derived.adrenaline.value"
                                       value="{{system.derived.adrenaline.value}}"
                                       min="0" max="{{system.derived.adrenaline.max}}" data-dtype="Number" />
                                <span class="sep">/</span>
                                <span class="derived-max">{{system.derived.adrenaline.max}}</span>
                            </div>
                        </div>
                        <div class="derived-block rest-actions">
                            <span class="derived-label">Recovery</span>
                            <div class="rest-action-buttons">
                                <button type="button" class="take-breather">Take a Breather</button>
                                <button type="button" class="standard-rest">Standard Rest</button>
                            </div>
                        </div>
                        <div class="derived-block">
                            <span class="derived-label">{{localize "LAUNDRY.Initiative"}}</span>
                            <span class="derived-value">{{system.derived.initiative.value}}</span>
                        </div>
                        <div class="derived-block">
                            <span class="derived-label">{{localize "LAUNDRY.NaturalAwareness"}}</span>
                            <span class="derived-value">{{system.derived.naturalAwareness.value}}</span>
                        </div>
                        <div class="derived-block">
                            <span class="derived-label">{{localize "LAUNDRY.Armour"}}</span>
                            <span class="derived-value">{{system.derived.armour.value}}</span>
                        </div>
                    </div>
                </section>

                <section class="panel">
                    <h3 class="section-header stamp-red">Field Readiness</h3>
                    <div class="ladder-grid">
                        <div class="ladder-entry">
                            <span class="ladder-label">{{localize "LAUNDRY.Melee"}}</span>
                            <span class="ladder-rating">{{ladder.melee}}</span>
                        </div>
                        <div class="ladder-entry">
                            <span class="ladder-label">{{localize "LAUNDRY.Accuracy"}}</span>
                            <span class="ladder-rating">{{ladder.accuracy}}</span>
                        </div>
                        <div class="ladder-entry">
                            <span class="ladder-label">{{localize "LAUNDRY.Defence"}}</span>
                            <span class="ladder-rating">{{ladder.defence}}</span>
                        </div>
                    </div>
                    <div class="xp-grid">
                        <div class="xp-block">
                            <label>{{localize "LAUNDRY.XPTotal"}}</label>
                            <input type="number" name="system.details.xp.value"
                                   value="{{system.details.xp.value}}" min="0" data-dtype="Number" />
                        </div>
                        <div class="xp-block">
                            <label>{{localize "LAUNDRY.XPUnspent"}}</label>
                            <input type="number" name="system.details.xp.unspent"
                                   value="{{system.details.xp.unspent}}" min="0" data-dtype="Number" />
                        </div>
                    </div>
                </section>

                <section class="panel dossier-bio">
                    <h3 class="section-header stamp-red">Biography</h3>
                    <div class="bio-profile-grid">
                        <label>
                            {{localize "LAUNDRY.BioCodename"}}
                            <input type="text" name="system.details.profile.codename" value="{{system.details.profile.codename}}" />
                        </label>
                        <label>
                            {{localize "LAUNDRY.BioBackground"}}
                            <input type="text" name="system.details.profile.background" value="{{system.details.profile.background}}" />
                        </label>
                        <label>
                            {{localize "LAUNDRY.BioCoverIdentity"}}
                            <input type="text" name="system.details.profile.coverIdentity" value="{{system.details.profile.coverIdentity}}" />
                        </label>
                        <label>
                            {{localize "LAUNDRY.BioNotableIncident"}}
                            <input type="text" name="system.details.profile.notableIncident" value="{{system.details.profile.notableIncident}}" />
                        </label>
                        <label>
                            {{localize "LAUNDRY.BioShortGoal"}}
                            <input type="text" name="system.details.profile.shortGoal" value="{{system.details.profile.shortGoal}}" />
                        </label>
                        <label>
                            {{localize "LAUNDRY.BioLongGoal"}}
                            <input type="text" name="system.details.profile.longGoal" value="{{system.details.profile.longGoal}}" />
                        </label>
                    </div>
                    <label class="bio-profile-notes">
                        {{localize "LAUNDRY.BioNotes"}}
                        <textarea name="system.details.profile.personalNotes" rows="2">{{system.details.profile.personalNotes}}</textarea>
                    </label>
                    <button type="button" class="bio-autofill">{{localize "LAUNDRY.BioAutofill"}}</button>
                    {{editor system.biography target="system.biography" button=true owner=owner editable=editable}}
                </section>
            </div>
        </div>

        <div class="tab combat" data-group="primary" data-tab="combat">
            <div class="panel-grid combat-panel-grid">
                <section class="panel">
                    <h3 class="section-header stamp-red">Combat Snapshot</h3>
                    <div class="combat-snapshot-grid">
                        <div class="combat-stat-card">
                            <span class="combat-stat-label">{{localize "LAUNDRY.Toughness"}}</span>
                            <span class="combat-stat-value">{{combatSnapshot.toughness.value}} / {{combatSnapshot.toughness.max}}</span>
                        </div>
                        <div class="combat-stat-card">
                            <span class="combat-stat-label">{{localize "LAUNDRY.Adrenaline"}}</span>
                            <span class="combat-stat-value">{{combatSnapshot.adrenaline.value}} / {{combatSnapshot.adrenaline.max}}</span>
                        </div>
                        <div class="combat-stat-card">
                            <span class="combat-stat-label">{{localize "LAUNDRY.Armour"}}</span>
                            <span class="combat-stat-value">{{combatSnapshot.armour}}</span>
                        </div>
                        <div class="combat-stat-card">
                            <span class="combat-stat-label">{{localize "LAUNDRY.Initiative"}}</span>
                            <span class="combat-stat-value">{{combatSnapshot.initiative}}</span>
                        </div>
                        <div class="combat-stat-card">
                            <span class="combat-stat-label">{{localize "LAUNDRY.NaturalAwareness"}}</span>
                            <span class="combat-stat-value">{{combatSnapshot.awareness}}</span>
                        </div>
                        <div class="combat-stat-card">
                            <span class="combat-stat-label">{{localize "LAUNDRY.Melee"}}</span>
                            <span class="combat-stat-value">{{combatSnapshot.melee.value}} ({{combatSnapshot.melee.label}})</span>
                        </div>
                        <div class="combat-stat-card">
                            <span class="combat-stat-label">{{localize "LAUNDRY.Accuracy"}}</span>
                            <span class="combat-stat-value">{{combatSnapshot.accuracy.value}} ({{combatSnapshot.accuracy.label}})</span>
                        </div>
                        <div class="combat-stat-card">
                            <span class="combat-stat-label">{{localize "LAUNDRY.Defence"}}</span>
                            <span class="combat-stat-value">{{combatSnapshot.defence.value}} ({{combatSnapshot.defence.label}})</span>
                        </div>
                    </div>
                </section>

                <section class="panel">
                    <h3 class="section-header stamp-red">Conditions</h3>
                    <div class="combat-status-grid">
                        {{#each combatConditions as |condition|}}
                        <button type="button"
                                class="combat-status-toggle {{#if condition.active}}active{{/if}}"
                                data-status-id="{{condition.id}}">
                            <img src="{{condition.img}}" title="{{condition.name}}" width="18" height="18" />
                            <span>{{condition.name}}</span>
                        </button>
                        {{/each}}
                    </div>
                    <p class="combat-note">{{combat.conditionSummary}}</p>
                </section>

                <section class="panel">
                    <h3 class="section-header stamp-red">Loadout</h3>
                    {{#if combat.hasLoadout}}
                    <ol class="items-list compact-list combat-loadout-list">
                        {{#each combatLoadout.weapons as |item|}}
                        <li class="item flexrow" data-item-id="{{item._id}}">
                            <div class="item-image rollable" data-roll-type="item">
                                <img src="{{item.img}}" title="{{item.name}}" width="20" height="20" />
                            </div>
                            <h4 class="item-name rollable" data-roll-type="item">{{item.name}}</h4>
                            <div class="item-formula">DMG {{item.system.damage}}</div>
                            <div class="item-formula">
                                {{item.system.traits}}
                                {{#if item.system.ammoMax}} | AMMO {{item.system.ammo}}/{{item.system.ammoMax}}{{/if}}
                            </div>
                            <div class="item-controls">
                                <a class="item-control item-equip" title="{{localize 'LAUNDRY.Equip'}}">
                                    <i class="fas fa-shield-alt"></i>
                                </a>
                            </div>
                        </li>
                        {{/each}}
                        {{#each combatLoadout.armour as |item|}}
                        <li class="item flexrow" data-item-id="{{item._id}}">
                            <div class="item-image">
                                <img src="{{item.img}}" title="{{item.name}}" width="20" height="20" />
                            </div>
                            <h4 class="item-name">{{item.name}}</h4>
                            <div class="item-formula">ARM {{item.system.protection}}</div>
                            <div class="item-formula">{{item.system.traits}}</div>
                            <div class="item-controls">
                                <a class="item-control item-equip" title="{{localize 'LAUNDRY.Equip'}}">
                                    <i class="fas fa-shield-alt"></i>
                                </a>
                            </div>
                        </li>
                        {{/each}}
                    </ol>
                    {{else}}
                    <p class="combat-note">No equipped weapons or armour. Equip items in Requisition or directly from this tab.</p>
                    {{/if}}
                </section>

                <section class="panel">
                    <h3 class="section-header stamp-red">Quick Actions</h3>
                    {{#if combat.canTrackTurnEconomy}}
                    <div class="combat-turn-economy">
                        <span><strong>Actions:</strong> {{combat.turnEconomy.actionsRemaining}}</span>
                        <span><strong>Move:</strong> {{combat.turnEconomy.moveRemaining}}</span>
                    </div>
                    {{/if}}
                    <div class="combat-quick-actions">
                        <button type="button" class="combat-roll-initiative">Roll Initiative</button>
                        {{#if combat.canManageTurnEconomy}}
                        <button type="button" class="combat-use-action">Use Action</button>
                        <button type="button" class="combat-use-move">Use Move</button>
                        <button type="button" class="combat-adrenaline-action">Spend Adrenaline (+1 Action)</button>
                        {{/if}}
                        <button type="button" class="take-breather">Take a Breather</button>
                        <button type="button" class="standard-rest">Standard Rest</button>
                        {{#if combat.canEndTurn}}
                        <button type="button" class="end-turn">{{localize "LAUNDRY.EndTurn"}}</button>
                        {{/if}}
                        {{#if combat.canOpenGmTracker}}
                        <button type="button" class="combat-open-gm-tracker">Open GM Tracker</button>
                        {{/if}}
                    </div>

                    <h4 class="combat-subheader">Core Combat Skills</h4>
                    <div class="combat-skill-grid">
                        {{#each combatSkills as |skill|}}
                        <div class="combat-skill-card rollable" data-roll-type="skill" data-skill-name="{{skill.name}}" data-attribute="{{skill.attribute}}">
                            <img src="{{skill.img}}" title="{{skill.name}}" width="24" height="24" />
                            <div class="combat-skill-meta">
                                <strong>{{skill.name}}</strong>
                                <span>{{skill.attributeLabel}} {{skill.attrValue}} | TR {{skill.training}} / F {{skill.focus}} | LVL {{skill.level}}</span>
                            </div>
                        </div>
                        {{/each}}
                    </div>

                    <p class="combat-note">{{combat.gmTrackerHint}}</p>
                </section>
            </div>
        </div>

        {{#if isNpc}}
        <div class="tab npc-ops" data-group="primary" data-tab="npc-ops">
            <div class="panel-grid npc-ops-grid">
                <section class="panel">
                    <h3 class="section-header stamp-red">NPC Automation</h3>
                    <div class="npc-ops-controls">
                        <label class="npc-ops-field">
                            <span>Preset</span>
                            <div class="npc-preset-row">
                                <select name="npcPreset">
                                    <option value="">Custom</option>
                                    {{#each npcOps.presets as |preset|}}
                                    <option value="{{preset.id}}" {{#if (laundryEq preset.id ../npcOps.archetype)}}selected{{/if}}>{{preset.name}}</option>
                                    {{/each}}
                                </select>
                                <button type="button" class="npc-preset-apply">Apply Preset</button>
                            </div>
                        </label>

                        <label class="npc-ops-field">
                            <span>Mode</span>
                            <select name="system.npc.mode">
                                <option value="lite" {{#if (laundryEq npcOps.mode "lite")}}selected{{/if}}>Lite</option>
                                <option value="full" {{#if (laundryEq npcOps.mode "full")}}selected{{/if}}>Full</option>
                            </select>
                        </label>

                        <label class="npc-ops-field">
                            <span>Class</span>
                            <select name="system.npc.class">
                                <option value="minion" {{#if (laundryEq npcOps.npcClass "minion")}}selected{{/if}}>Minion</option>
                                <option value="elite" {{#if (laundryEq npcOps.npcClass "elite")}}selected{{/if}}>Elite</option>
                                <option value="boss" {{#if (laundryEq npcOps.npcClass "boss")}}selected{{/if}}>Boss</option>
                            </select>
                        </label>

                        <label class="npc-ops-field">
                            <span>Mob Size</span>
                            <input type="number" name="system.npc.mobSize" value="{{npcOps.mobSize}}" min="1" max="50" data-dtype="Number" />
                        </label>

                        <label class="npc-ops-check">
                            <input type="checkbox" name="system.npc.fastDamage" {{checked npcOps.fastDamage}} />
                            <span>Fast Damage</span>
                        </label>
                        <label class="npc-ops-check">
                            <input type="checkbox" name="system.npc.trackInjuries" {{checked npcOps.trackInjuries}} />
                            <span>Track Injuries</span>
                        </label>
                        <label class="npc-ops-check">
                            <input type="checkbox" name="system.npc.defeated" {{checked npcOps.defeated}} />
                            <span>Defeated</span>
                        </label>
                    </div>

                    {{#if npcOps.defeated}}
                    <div class="npc-defeated-banner">☠ Defeated</div>
                    <button type="button" class="npc-reset-defeated">Reset Defeated State</button>
                    {{/if}}
                </section>

                <section class="panel">
                    <h3 class="section-header stamp-red">One-Line Actions</h3>
                    {{#unless editable}}
                    <p class="combat-note npc-actions-readonly">Read-only enemy source. Import/duplicate to world to edit actions.</p>
                    {{/unless}}
                    {{#if editable}}
                    <div class="npc-actions-toolbar">
                        <button type="button" class="npc-action-add" data-action-kind="attack">Add Attack</button>
                        <button type="button" class="npc-action-add" data-action-kind="spell">Add Spell</button>
                        <button type="button" class="npc-action-add" data-action-kind="test">Add Test</button>
                        <button type="button" class="npc-action-autofill">Auto-Build from Loadout</button>
                    </div>
                    {{else}}
                    <a class="npc-import-world" href="#" role="button">Create Editable World Copy</a>
                    {{/if}}
                    {{#if npcOps.usingSuggestedActions}}
                    <p class="combat-note">Showing suggested one-line actions from loadout. Click Auto-Build to save them.</p>
                    {{/if}}
                    <ol class="items-list compact-list npc-actions-list">
                        <li class="item flexrow item-header">
                            <div class="npc-col npc-col-name">Name</div>
                            <div class="npc-col npc-col-kind">Kind</div>
                            <div class="npc-col npc-col-num">Pool</div>
                            <div class="npc-col npc-col-num">DN</div>
                            <div class="npc-col npc-col-num">Comp</div>
                            <div class="npc-col npc-col-damage">Damage</div>
                            <div class="npc-col npc-col-traits">Traits</div>
                            <div class="npc-col npc-col-magic">Magic</div>
                            <div class="npc-col npc-col-controls">Actions</div>
                        </li>
                        {{#each npcOps.quickActions as |action|}}
                        <li class="item flexrow npc-action-row" data-action-index="{{action.index}}" data-action-id="{{action.id}}">
                            <div class="npc-col npc-col-name" data-label="Name">
                                <input class="npc-action-field" data-action-index="{{action.index}}" data-action-key="name" type="text" value="{{action.name}}" />
                            </div>
                            <div class="npc-col npc-col-kind" data-label="Kind">
                                <select class="npc-action-field" data-action-index="{{action.index}}" data-action-key="kind">
                                    {{#each @root.npcOps.actionKinds as |kind|}}
                                    <option value="{{kind.id}}" {{#if (laundryEq kind.id ../action.kind)}}selected{{/if}}>{{kind.name}}</option>
                                    {{/each}}
                                </select>
                            </div>
                            <div class="npc-col npc-col-num" data-label="Pool">
                                <input class="npc-action-field" data-action-index="{{action.index}}" data-action-key="pool" type="number" min="0" max="20" value="{{action.pool}}" data-dtype="Number" />
                            </div>
                            <div class="npc-col npc-col-num" data-label="DN">
                                <input class="npc-action-field" data-action-index="{{action.index}}" data-action-key="dn" type="number" min="2" max="6" value="{{action.dn}}" data-dtype="Number" />
                            </div>
                            <div class="npc-col npc-col-num" data-label="Complexity">
                                <input class="npc-action-field" data-action-index="{{action.index}}" data-action-key="complexity" type="number" min="1" max="10" value="{{action.complexity}}" data-dtype="Number" />
                            </div>
                            <div class="npc-col npc-col-damage" data-label="Damage">
                                <input class="npc-action-field" data-action-index="{{action.index}}" data-action-key="damage" type="text" value="{{action.damage}}" />
                            </div>
                            <div class="npc-col npc-col-traits" data-label="Traits">
                                <input class="npc-action-field" data-action-index="{{action.index}}" data-action-key="traits" type="text" value="{{action.traits}}" />
                            </div>
                            <div class="npc-col npc-col-magic" data-label="Magic">
                                <input class="npc-action-field" data-action-index="{{action.index}}" data-action-key="isMagic" type="checkbox" {{checked action.isMagic}} />
                            </div>
                            <div class="npc-col npc-col-controls" data-label="Actions">
                                <button type="button" class="npc-action-roll" data-action-index="{{action.index}}" data-action-id="{{action.id}}">Roll</button>
                                <button type="button" class="npc-action-duplicate" data-action-index="{{action.index}}" data-action-id="{{action.id}}">Dup</button>
                                <button type="button" class="npc-action-move" data-action-index="{{action.index}}" data-action-id="{{action.id}}" data-direction="up" {{#unless action.canMoveUp}}disabled{{/unless}}>Up</button>
                                <button type="button" class="npc-action-move" data-action-index="{{action.index}}" data-action-id="{{action.id}}" data-direction="down" {{#unless action.canMoveDown}}disabled{{/unless}}>Down</button>
                                <button type="button" class="npc-action-delete" data-action-index="{{action.index}}" data-action-id="{{action.id}}">Delete</button>
                            </div>
                        </li>
                        {{/each}}
                    </ol>
                    {{#unless npcOps.quickActions.length}}
                    <p class="combat-note">No one-line actions yet. Use Add Attack/Spell/Test.</p>
                    {{/unless}}
                    <p class="combat-note">NPC Lite flow: set Fast Damage and Mob Size, then run actions directly from this tab.</p>
                </section>
            </div>
        </div>
        {{/if}}

        <div class="tab skills" data-group="primary" data-tab="skills">
            <section class="panel">
                <h3 class="section-header stamp-red">Skills</h3>
                <ol class="items-list compact-list">
                    <li class="item flexrow item-header">
                        <div class="item-image"></div>
                        <div class="item-name">{{localize "LAUNDRY.Name"}}</div>
                        <div class="item-formula">{{localize "LAUNDRY.RelatedAttribute"}}</div>
                        <div class="item-formula">{{localize "LAUNDRY.Training"}} / {{localize "LAUNDRY.Focus"}}</div>
                        <div class="item-formula">{{localize "LAUNDRY.Level"}}</div>
                        <div class="item-controls">
                            <a class="item-control item-create" data-type="skill" title="{{localize 'LAUNDRY.AddSkill'}}">
                                <i class="fas fa-plus"></i>
                            </a>
                        </div>
                    </li>
                    {{#each skillRows as |skill|}}
                    <li class="item flexrow skill-row" {{#if skill.itemId}}data-item-id="{{skill.itemId}}"{{/if}}>
                        <div class="item-image rollable" data-roll-type="skill" data-skill-name="{{skill.name}}" data-attribute="{{skill.attribute}}">
                            <img src="{{skill.img}}" title="{{skill.name}}" width="20" height="20" />
                        </div>
                        <h4 class="item-name rollable" data-roll-type="skill" data-skill-name="{{skill.name}}" data-attribute="{{skill.attribute}}">
                            {{skill.name}}
                            {{#if skill.trained}}
                            <span class="skill-trained-pill">TR</span>
                            {{/if}}
                        </h4>
                        <div class="item-formula">
                            <select class="skill-attr" data-skill-name="{{skill.name}}">
                                <option value="body" {{#if (laundryEq skill.attribute "body")}}selected{{/if}}>{{localize "LAUNDRY.Body"}}</option>
                                <option value="mind" {{#if (laundryEq skill.attribute "mind")}}selected{{/if}}>{{localize "LAUNDRY.Mind"}}</option>
                                <option value="spirit" {{#if (laundryEq skill.attribute "spirit")}}selected{{/if}}>{{localize "LAUNDRY.Spirit"}}</option>
                            </select>
                            <span class="attr-tag">{{skill.attrValue}}</span>
                        </div>
                        <div class="item-formula">
                            <div class="skill-adjust-group">
                                <button type="button" class="skill-adjust" data-skill-name="{{skill.name}}" data-attribute="{{skill.attribute}}" data-stat="training" data-delta="-1">-</button>
                                <span class="skill-value">{{skill.training}}</span>
                                <button type="button" class="skill-adjust" data-skill-name="{{skill.name}}" data-attribute="{{skill.attribute}}" data-stat="training" data-delta="1">+</button>
                                <span class="skill-sep">/</span>
                                <button type="button" class="skill-adjust" data-skill-name="{{skill.name}}" data-attribute="{{skill.attribute}}" data-stat="focus" data-delta="-1">-</button>
                                <span class="skill-value">{{skill.focus}}</span>
                                <button type="button" class="skill-adjust" data-skill-name="{{skill.name}}" data-attribute="{{skill.attribute}}" data-stat="focus" data-delta="1">+</button>
                            </div>
                        </div>
                        <div class="item-formula">
                            <span class="skill-level">{{skill.level}}</span>
                        </div>
                        <div class="item-controls">
                            {{#if skill.itemId}}
                            <a class="item-control item-edit" title="{{localize 'LAUNDRY.Edit'}}"><i class="fas fa-edit"></i></a>
                            <a class="item-control item-delete" title="{{localize 'LAUNDRY.Delete'}}"><i class="fas fa-trash"></i></a>
                            {{/if}}
                        </div>
                    </li>
                    {{/each}}
                </ol>
            </section>

            <section class="panel">
                <h3 class="section-header stamp-red">Talents</h3>
                <ol class="items-list compact-list">
                    <li class="item flexrow item-header">
                        <div class="item-image"></div>
                        <div class="item-name">{{localize "LAUNDRY.Talents"}}</div>
                        <div class="item-controls">
                            <a class="item-control item-create" data-type="talent" title="{{localize 'LAUNDRY.AddTalent'}}">
                                <i class="fas fa-plus"></i>
                            </a>
                        </div>
                    </li>
                    {{#each talents as |item|}}
                    <li class="item flexrow" data-item-id="{{item._id}}">
                        <div class="item-image">
                            <img src="{{item.img}}" title="{{item.name}}" width="20" height="20" />
                        </div>
                        <h4 class="item-name">{{item.name}}</h4>
                        <div class="item-detail talent-detail">
                            <div class="talent-requirements"><strong>{{localize "LAUNDRY.Requirements"}}:</strong> {{item.system.requirements}}</div>
                            <div class="talent-prereq-line">
                                <span class="talent-prereq-badge {{item.prereqCss}}" title="{{item.prereqSummary}}">
                                    {{item.prereqStatusLabel}}
                                </span>
                            </div>
                        </div>
                        <div class="item-controls">
                            <a class="item-control item-edit" title="{{localize 'LAUNDRY.Edit'}}"><i class="fas fa-edit"></i></a>
                            <a class="item-control item-delete" title="{{localize 'LAUNDRY.Delete'}}"><i class="fas fa-trash"></i></a>
                        </div>
                    </li>
                    {{/each}}
                </ol>
            </section>
        </div>

        <div class="tab requisition" data-group="primary" data-tab="requisition">
            <section class="panel">
                <div class="inventory-tabs">
                    <a class="inv-tab active" data-inv-tab="all">{{localize "LAUNDRY.All"}}</a>
                    <a class="inv-tab" data-inv-tab="weapon">{{localize "LAUNDRY.Weapons"}}</a>
                    <a class="inv-tab" data-inv-tab="armour">{{localize "LAUNDRY.Armour"}}</a>
                    <a class="inv-tab" data-inv-tab="gear">{{localize "LAUNDRY.Gear"}}</a>
                </div>
                <div class="requisition-actions-row">
                    <button type="button" class="call-support">Requisition &amp; Support</button>
                    <button type="button" class="take-downtime open-endeavours">Take Downtime</button>
                </div>
                <div class="inventory-search-row">
                    <input type="text" class="inv-search" placeholder="{{localize 'LAUNDRY.SearchByName'}}" />
                </div>
                <ol class="items-list compact-list">
                    <li class="item flexrow item-header">
                        <div class="item-image"></div>
                        <div class="item-name">{{localize "LAUNDRY.Name"}}</div>
                        <div class="item-detail">{{localize "LAUNDRY.Traits"}}</div>
                        <div class="item-controls">
                            <a class="item-control item-create" data-type="gear" title="{{localize 'LAUNDRY.AddItem'}}">
                                <i class="fas fa-plus"></i>
                            </a>
                        </div>
                    </li>
                    {{#each gear as |item|}}
                    <li class="item flexrow inv-row" data-item-id="{{item._id}}" data-inv-type="{{item.type}}">
                        <div class="item-image rollable" data-roll-type="item">
                            <img src="{{item.img}}" title="{{item.name}}" width="20" height="20" />
                        </div>
                        <h4 class="item-name rollable" data-roll-type="item">{{item.name}}</h4>
                        <div class="item-detail">
                            {{#if (laundryEq item.type "weapon")}}
                                <span class="gear-tag weapon-tag">WPN {{item.system.damage}}</span>
                                {{#if item.system.ammoMax}}
                                <span class="gear-tag">AMMO {{item.system.ammo}}/{{item.system.ammoMax}}</span>
                                {{/if}}
                            {{/if}}
                            {{#if (laundryEq item.type "armour")}}
                                <span class="gear-tag armour-tag">ARM +{{item.system.protection}}</span>
                            {{/if}}
                            {{#if (laundryEq item.type "gear")}}
                                <span class="gear-tag">×{{item.system.quantity}}</span>
                            {{/if}}
                        </div>
                        <div class="item-controls">
                            {{#if (laundryOr (laundryEq item.type "weapon") (laundryEq item.type "armour"))}}
                            <a class="item-control item-equip {{#if item.system.equipped}}equipped{{/if}}"
                               title="{{localize 'LAUNDRY.Equip'}}">
                                <i class="fas fa-shield-alt"></i>
                            </a>
                            {{/if}}
                            <a class="item-control item-edit" title="{{localize 'LAUNDRY.Edit'}}"><i class="fas fa-edit"></i></a>
                            <a class="item-control item-delete" title="{{localize 'LAUNDRY.Delete'}}"><i class="fas fa-trash"></i></a>
                        </div>
                    </li>
                    {{/each}}
                </ol>
            </section>
        </div>

        <div class="tab kpis" data-group="primary" data-tab="kpis">
            <section class="panel">
                <div class="kpi-head kpi-head-main">
                    <h3 class="section-header stamp-red">{{localize "LAUNDRY.KPIs"}}</h3>
                </div>
                <div class="kpi-summary-row">
                    <span class="kpi-summary-chip">{{localize "LAUNDRY.KPIStatusOpen"}}: <strong>{{kpiSummary.open}}</strong></span>
                    <span class="kpi-summary-chip">{{localize "LAUNDRY.KPIStatusCompleted"}}: <strong>{{kpiSummary.completed}}</strong></span>
                    <span class="kpi-summary-chip">{{localize "LAUNDRY.KPIStatusFailed"}}: <strong>{{kpiSummary.failed}}</strong></span>
                </div>
                {{#each kpiGroups as |group|}}
                <div class="kpi-group">
                    <div class="kpi-group-head">
                        <h4>{{group.label}}</h4>
                        <button type="button" class="kpi-add" data-kpi-horizon="{{group.key}}">{{localize "LAUNDRY.AddKPI"}}</button>
                    </div>
                    <ol class="items-list compact-list kpi-list">
                        {{#each group.entries as |kpi|}}
                        <li class="item flexrow kpi-row {{kpi.statusCss}}" data-kpi-index="{{kpi.index}}">
                            <div class="kpi-main">
                                <input
                                    type="text"
                                    class="kpi-field kpi-text-input"
                                    data-kpi-index="{{kpi.index}}"
                                    data-kpi-key="text"
                                    value="{{kpi.text}}"
                                    placeholder="{{localize 'LAUNDRY.KPIPlaceholder'}}"
                                />
                                <input
                                    type="text"
                                    class="kpi-field kpi-owner-input"
                                    data-kpi-index="{{kpi.index}}"
                                    data-kpi-key="owner"
                                    value="{{kpi.owner}}"
                                    placeholder="{{localize 'LAUNDRY.KPIOwner'}}"
                                />
                            </div>
                            <div class="kpi-meta">
                                <label>
                                    {{localize "LAUNDRY.KPIStatus"}}
                                    <select class="kpi-field" data-kpi-index="{{kpi.index}}" data-kpi-key="status">
                                        {{#each @root.kpiOptions.statuses as |option|}}
                                        <option value="{{option.key}}" {{#if (laundryEq option.key ../status)}}selected{{/if}}>{{option.label}}</option>
                                        {{/each}}
                                    </select>
                                </label>
                                <label>
                                    {{localize "LAUNDRY.KPIPriority"}}
                                    <select class="kpi-field" data-kpi-index="{{kpi.index}}" data-kpi-key="priority">
                                        {{#each @root.kpiOptions.priorities as |option|}}
                                        <option value="{{option.key}}" {{#if (laundryEq option.key ../priority)}}selected{{/if}}>{{option.label}}</option>
                                        {{/each}}
                                    </select>
                                </label>
                                <label>
                                    {{localize "LAUNDRY.KPIDueDate"}}
                                    <input type="date" class="kpi-field" data-kpi-index="{{kpi.index}}" data-kpi-key="dueDate" value="{{kpi.dueDate}}" />
                                </label>
                                <label>
                                    {{localize "LAUNDRY.KPIProgress"}}
                                    <input type="number" min="0" max="100" class="kpi-field kpi-progress-input" data-kpi-index="{{kpi.index}}" data-kpi-key="progress" value="{{kpi.progress}}" />
                                </label>
                                <label>
                                    {{localize "LAUNDRY.KPIType"}}
                                    <select class="kpi-field" data-kpi-index="{{kpi.index}}" data-kpi-key="horizon">
                                        {{#each @root.kpiOptions.horizons as |option|}}
                                        <option value="{{option.key}}" {{#if (laundryEq option.key ../horizon)}}selected{{/if}}>{{option.label}}</option>
                                        {{/each}}
                                    </select>
                                </label>
                            </div>
                            <a class="item-control kpi-delete" data-kpi-index="{{kpi.index}}" title="{{localize 'LAUNDRY.Delete'}}">
                                <i class="fas fa-trash"></i>
                            </a>
                        </li>
                        {{/each}}
                    </ol>
                </div>
                {{/each}}
            </section>
        </div>

        <div class="tab magic" data-group="primary" data-tab="magic">
            <section class="panel">
                <h3 class="section-header stamp-red">Magic</h3>
                <ol class="items-list compact-list">
                    <li class="item flexrow item-header">
                        <div class="item-image"></div>
                        <div class="item-name">{{localize "LAUNDRY.Name"}}</div>
                        <div class="item-detail">
                            {{localize "LAUNDRY.Level"}} / {{localize "LAUNDRY.DN"}} / {{localize "LAUNDRY.Complexity"}}
                        </div>
                        <div class="item-controls">
                            <a class="item-control item-create" data-type="spell" title="{{localize 'LAUNDRY.AddSpell'}}">
                                <i class="fas fa-plus"></i>
                            </a>
                        </div>
                    </li>
                    {{#each spells as |item|}}
                    <li class="item flexrow" data-item-id="{{item._id}}">
                        <div class="item-image rollable" data-roll-type="item">
                            <img src="{{item.img}}" title="{{item.name}}" width="20" height="20" />
                        </div>
                        <h4 class="item-name rollable" data-roll-type="item">{{item.name}}</h4>
                        <div class="item-detail">
                            <span class="gear-tag spell-tag">L{{item.system.level}}</span>
                            <span class="gear-tag dn-tag">DN {{#if item.system.dn}}{{item.system.dn}}{{else}}4{{/if}}</span>
                            <span class="gear-tag complexity-tag">C {{#if item.system.complexity}}{{item.system.complexity}}{{else}}{{item.system.level}}{{/if}}</span>
                        </div>
                        <div class="item-controls">
                            <a class="item-control item-edit" title="{{localize 'LAUNDRY.Edit'}}"><i class="fas fa-edit"></i></a>
                            <a class="item-control item-delete" title="{{localize 'LAUNDRY.Delete'}}"><i class="fas fa-trash"></i></a>
                        </div>
                    </li>
                    {{/each}}
                </ol>
            </section>
        </div>

    </section>
</form>
