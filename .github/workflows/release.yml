name: Release Laundry RPG

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run tests
        run: node --test tests/*.test.mjs

      - name: Run compendium QA
        run: node scripts/qa_compendiums.mjs

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Rebuild packs
        run: python3 scripts/rebuild_packs_from_json.py

      - name: Ensure pack artifacts are up to date
        run: git diff --exit-code -- packs

      - name: Validate versions
        run: |
          set -euo pipefail
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          SYSTEM_VERSION="$(node -p "require('./system.json').version")"
          MANIFEST_VERSION="$(node -p "require('./manifest.json').version")"

          if [ "${SYSTEM_VERSION}" != "${MANIFEST_VERSION}" ]; then
            echo "system.json (${SYSTEM_VERSION}) and manifest.json (${MANIFEST_VERSION}) versions do not match."
            exit 1
          fi

          if [ "${TAG_VERSION}" != "${SYSTEM_VERSION}" ]; then
            echo "Tag version (${TAG_VERSION}) does not match system version (${SYSTEM_VERSION})."
            exit 1
          fi

      - name: Build archive
        run: |
          set -euo pipefail
          rm -f system.zip
          git archive --format=zip --output=system.zip HEAD

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            system.zip
            manifest.json
            system.json
